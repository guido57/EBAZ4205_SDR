//Example code: A simple server side code, which echos back the received message.
//Handle multiple socket connections with select and fd_set on Linux
#include <stdio.h>
#include <string.h>   //strlen
#include <stdlib.h>
#include <errno.h>
#include <unistd.h>   //close
#include <arpa/inet.h>    //close
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <sys/time.h> //FD_SET, FD_ISSET, FD_ZERO macros

#define TRUE   1
#define FALSE  0
#define PORT 1001

#include "dds.h"
#include "mux.h"
#include "FILTER_GAIN.h"
#include "DEC_RATE.h"

int size_in_k = 64;

// Create the DDS object acting as a Local Oscillator
DDS *dds_lo;

// Create the DDS object acting as a Signal Generator
DDS *dds_sg;

// Create the DEC_RATE to change the CIC filter Decimation Rate between 4 and 8192
DEC_RATE *dec_rate;

// Create the FILTER_GAIN to change the CIC-FIR gain between 1 and 65536
FILTER_GAIN *filter_gain;

// Create the MUX object to select ADC input or RF generator
MUX *mux;

// get milliseconds
long millis(){

  struct timeval tm;
  gettimeofday(&tm, NULL);
  long msecs = tm.tv_sec * 1000 + tm.tv_usec/1000 + 0.5;
  return msecs;
}


int main(int argc , char *argv[])
{
    int opt = TRUE;
    int master_socket , addrlen , new_socket , client_socket[30] ,
          max_clients = 30 , activity, i , valread , sd;
    int max_sd;
    struct sockaddr_in address;

    char buffer[1025];  //data buffer of 1K

    // Create the DDS object acting ad a Local Oscillator with a clock frequency=64000 KHz (64MHz) and 26 bit step phase width
    dds_lo = new DDS(0x43C10000, size_in_k, 64000.0, 26);

    // Create the DDS object acting a a Signal Generator with a clock frequency=64000 KHz (64MHz) and 26 bit step phase width
    dds_sg = new DDS(0x41210000, size_in_k, 64000.0, 26);
    // set its frequency at 10MHz
    dds_sg->set_frequency(10000.0); // 10000.0 KHz = 10 MHz

    // Create the DEC_RATE object and set Decimation Rate
    dec_rate = new DEC_RATE(0x43C30000, size_in_k);
    dec_rate->set_dec_rate(1024);

    // Create the FILTER_GAIN object and set its gain
    filter_gain = new FILTER_GAIN(0x43C20000, size_in_k);
    filter_gain->set_filter_gain(4);

    // Create the MUX object to select ADC input or RF generator
    mux = new MUX(0x41210000, size_in_k);
    // select Signal Generator Input
	mux->select(0);

	double f = 10000.0;
	for(int i = 0; i<1000;i++){
		dds_lo->set_frequency(f); // 10000 KHz
	}


    return 0;
}
